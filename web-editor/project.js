var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return function(t,r){e(t,r);function n(){this.constructor=t}t.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}}();var __awaiter=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n["throw"](e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(a,s)}c((n=n.apply(e,t||[])).next())})};var __generator=this&&this.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:s(0),throw:s(1),return:s(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function s(e){return function(t){return c([e,t])}}function c(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=o[a[0]&2?"return":a[0]?"throw":"next"])&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[0,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};(function(e){if(typeof module==="object"&&typeof module.exports==="object"){var t=e(require,exports);if(t!==undefined)module.exports=t}else if(typeof define==="function"&&define.amd){define(["require","exports","vs/editor/editor.main","@dojo/core/Evented","@dojo/core/lang","@dojo/core/request","@dojo/shim/array","@dojo/shim/WeakMap","./support/css","./support/json"],e)}})(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:true});e("vs/editor/editor.main");var r=e("@dojo/core/Evented");var n=e("@dojo/core/lang");var o=e("@dojo/core/request");var i=e("@dojo/shim/array");var a=e("@dojo/shim/WeakMap");var s=e("./support/css");var c=e("./support/json");function u(e,t){if(typeof e==="string"){return e}else{var r=e;var n="";var o=0;while(r){if(o){n+=t;for(var i=0;i<o;i++){n+="  "}}n+=r.messageText;o++;r=r.next}return n}}function l(e){var t=e.name,r=e.text,n=e.type;return monaco.editor.createModel(r,p(n),monaco.Uri.file(t))}function p(e){switch(e){case 2:case 1:case 3:return"typescript";case 6:return"html";case 4:return"javascript";case 7:return"markdown";case 5:return"css";case 10:case 8:return"json";case 11:return"plaintext";case 9:return"xml";default:return"unknown"}}var f=monaco.languages.typescript.ScriptTarget;function d(e){switch(e){case"es3":return f.ES3;case"es5":return f.ES5;case"es6":case"es2015":return f.ES2015;case"es7":case"es2016":return f.ES2016;case"es8":case"es2017":return f.ES2017;case"esnext":return f.ESNext;case"latest":default:return f.ES5}}var h=function(e){__extends(t,e);function t(){var t=e!==null&&e.apply(this,arguments)||this;t._fileMap=new a.default;return t}t.prototype._checkEmitErrors=function(e,t){return __awaiter(this,void 0,void 0,function(){var r,n,o,i;return __generator(this,function(a){switch(a.label){case 0:return[4,e.getCompilerOptionsDiagnostics()];case 1:o=(n=a.sent()).concat;return[4,e.getSemanticDiagnostics(t)];case 2:i=[a.sent()];return[4,e.getSyntacticDiagnostics(t)];case 3:r=o.apply(n,i.concat([a.sent()]));r.forEach(function(e){var t=u(e.messageText,"\n");if(e.file){var r=e.file.getLineAndCharacterOfPosition(e.start),n=r.line,o=r.character;console.warn("Error "+e.file.name+" ("+(n+1)+","+(o+1)+"): "+t)}else{console.warn("Error: "+t)}});return[2]}})})};t.prototype._loadBundle=function(e){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(i){switch(i.label){case 0:t=this;n=(r=JSON).parse;return[4,o.default(e)];case 1:return[4,i.sent().text()];case 2:t._project=n.apply(r,[i.sent()]);return[2]}})})};t.prototype._getProjectFileData=function(e){if(!this._fileMap.has(e)){this._fileMap.set(e,{})}return this._fileMap.get(e)};t.prototype._setEnvironmentFiles=function(){this._project.environmentFiles.forEach(function(e){var t=e.name,r=e.text,n=e.type;monaco.languages.typescript.typescriptDefaults.addExtraLib(r,(n===3?"":"file:///")+t)})};t.prototype._setProjectFiles=function(){var e=this;this._project.files.forEach(function(t){var r=t.name,n=t.text,o=t.type;if(o===1||o===2){var i=e._getProjectFileData(t);i.extraLibHandle=monaco.languages.typescript.typescriptDefaults.addExtraLib(n,"file:///"+r)}})};t.prototype._setTypeScriptEnvironment=function(){var e=this._project.tsconfig.compilerOptions,t=e===void 0?{}:e;var r={};var o=t.experimentalDecorators,i=t.lib,a=t.noImplicitAny,s=t.noImplicitThis,c=t.noImplicitReturns,u=t.noLib,l=t.noUnusedLocals,p=t.noUnusedParameters,f=t.strictNullChecks,h=t.target,m=t.types;n.assign(r,{experimentalDecorators:o,lib:i,noImplicitAny:a,noImplicitThis:s,noImplicitReturns:c,noLib:u,noUnusedLocals:l,noUnusedParameters:p,strictNullChecks:f,target:d(h),types:m});n.assign(r,{allowNonTsExtensions:true,inlineSources:true,module:monaco.languages.typescript.ModuleKind.AMD,moduleResolution:monaco.languages.typescript.ModuleResolutionKind.NodeJs,noEmitHelpers:true,sourceMap:true});monaco.languages.typescript.typescriptDefaults.setCompilerOptions(r)};t.prototype._updateBundle=function(){var e=this;if(!this._project){return}this._project.files.filter(function(t){var r=t.name;return e.isFileDirty(r)}).forEach(function(t){t.text=e.getFileModel(t.name).getValue();e.setFileDirty(t.name,true)})};t.prototype._updateCssModule=function(e){return __awaiter(this,void 0,void 0,function(){var t,r,n,o,a;return __generator(this,function(c){switch(c.label){case 0:e.text=this._getProjectFileData(e).model.getValue();return[4,s.getDefinitions(e)];case 1:t=c.sent()[0];r=i.find(this._project.files,function(e){var r=e.name;return r===t.name});if(r){r.text=t.text;t=r}else{this._project.files.push(t)}n=t.name,o=t.text;a=this._getProjectFileData(t);if(a.extraLibHandle){a.extraLibHandle.dispose()}a.extraLibHandle=monaco.languages.typescript.typescriptDefaults.addExtraLib(o,"file:///"+n);return[2]}})})};t.prototype.emit=function(){return __awaiter(this,void 0,void 0,function(){var e=this;var t,r,n,o,i,a,u;return __generator(this,function(l){switch(l.label){case 0:if(!this._project){throw new Error("Project not loaded.")}t=this._project.files.filter(function(e){var t=e.type;return t===2||t===1}).map(function(t){var r=t.name;return e.getFileModel(r).uri});return[4,monaco.languages.typescript.getTypeScriptWorker()];case 1:r=l.sent();return[4,r.apply(void 0,t)];case 2:n=l.sent();return[4,Promise.all(t.map(function(t){return __awaiter(e,void 0,void 0,function(){var e,r;return __generator(this,function(o){switch(o.label){case 0:e=t.toString();return[4,n.getEmitOutput(e)];case 1:r=o.sent();return[4,this._checkEmitErrors(n,e)];case 2:o.sent();return[2,r]}})})}))];case 3:o=l.sent();return[4,s.getEmit.apply(void 0,this._project.files.filter(function(e){var t=e.type;return t===5}).map(function(t){var r=t.name,n=t.type;return{model:e.getFileModel(r),type:n}}).map(function(e){var t=e.model,r=e.type;return{name:t.uri.fsPath.replace(/^\/\.\//,""),text:t.getValue(),type:r}}))];case 4:i=l.sent();a=c.getEmit.apply(void 0,this._project.files.filter(function(e){var t=e.type;return t===8}).map(function(t){var r=t.name,n=t.type;return{model:e.getFileModel(r),type:n}}).map(function(e){var t=e.model,r=e.type;return{name:t.uri.fsPath.replace(/^\/\.\//,""),text:t.getValue(),type:r}}));u=this._project.files.filter(function(e){var t=e.type;return t!==2&&t!==1&&t!==5&&t!==8}).map(function(t){var r=t.name,n=t.type;return{model:e.getFileModel(r),type:n}}).map(function(e){var t=e.model,r=e.type;return{name:t.uri.fsPath.replace(/^\/\.\//,""),text:t.getValue(),type:r}});return[2,o.reduce(function(e,t){return e.concat(t.outputFiles)},[]).map(function(e){var t=e.text,r=e.name;return{text:t,name:r.replace("file:///",""),type:/^(.*\.(?!map$))?[^.]*$/.test(r)?4:10}}).concat(i,a,u)]}})})};t.prototype.get=function(){this._updateBundle();return this._project};t.prototype.getDependencies=function(e){if(e===void 0){e=false}if(!this._project){throw new Error("Project not loaded.")}return n.assign({},this._project.dependencies.production,e?this._project.dependencies.development:undefined)};t.prototype.getFile=function(e){if(!this._project){throw new Error("Project not loaded.")}return i.find(this._project.files,function(t){var r=t.name;return r===e})};t.prototype.getFiles=function(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}if(!this._project){throw new Error("Project not loaded.")}var r=this._project.files.map(function(e){var t=e.name;return t});return this._project.files.filter(function(t){var n=t.name,o=t.type;return!(o===2&&i.includes(r,n.replace(/\.d\.ts$/,"")))&&(e.length?i.includes(e,o):true)})};t.prototype.getFileModel=function(e){var t=this.getFile(e);if(!t){throw new Error('File "'+e+'" is not part of the project.')}var r=this._getProjectFileData(t);if(!r.model){r.model=l(t)}return r.model};t.prototype.getFileNames=function(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}return this.getFiles.apply(this,e).map(function(e){var t=e.name;return t})};t.prototype.getFileText=function(e){return this.getFileModel(e).getValue()};t.prototype.getIndexHtml=function(){if(!this._project){throw new Error("Project not loaded.")}return this.getFileText(this._project.index)};t.prototype.includes=function(e){return Boolean(this._project&&i.includes(this.getFileNames(),e))};t.prototype.isFileDirty=function(e){var t=this.getFile(e);return Boolean(t&&this._getProjectFileData(t).dirty)};t.prototype.isLoaded=function(){return Boolean(this._project)};t.prototype.load=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:if(this._project){throw new Error("Project is already loaded.")}return[4,this._loadBundle(e)];case 1:t.sent();this._setTypeScriptEnvironment();this._setEnvironmentFiles();this._setProjectFiles();return[2]}})})};t.prototype.setFileDirty=function(e,t){var r=this.getFile(e);if(!r){throw new Error('File "'+e+'" is not part of the project.')}if(r.type===5){this._updateCssModule(r)}else{this._getProjectFileData(r).dirty=!t}};return t}(r.default);t.Project=h;var m=new h;t.default=m});